name: Insider Report

on:
  schedule:
    # 17:50 WIB = 10:50 UTC (Senin–Jumat)
    - cron: '50 10 * * 1-5'
  workflow_dispatch:
    inputs:
      from:
        description: 'Window start (YYYY-MM-DD HH:MM, WIB)'
        required: false
        type: string
      to:
        description: 'Window end (YYYY-MM-DD HH:MM, WIB)'
        required: false
        type: string
      symbols:
        description: 'Comma-separated symbols to override watchlist (e.g., BBCA.JK,BBRI.JK)'
        required: false
        type: string
      recipients_override:
        description: 'Override recipients (comma-separated). If empty, uses REPORT_RECIPIENTS secret'
        required: false
        type: string
      whatsapp_recipients_override:
        description: 'Override WhatsApp recipient (comma-separated). Uses secret if empty.'
        required: false
        type: string
      attach_html:
        description: 'Attach HTML to email? (body HTML tetap dikirim walau false)'
        required: false
        default: false
        type: boolean
      send:
        description: 'Send email? (true/false) — only used for manual runs; scheduled runs default to true'
        required: false
        default: true
        type: boolean
      send_whatsapp:
        description: 'Send WhatsApp? (true/false)'
        required: false
        default: true
        type: boolean
      send_timing:
        description: 'When to send (manual runs): "now" or "wait" (wait = 18:00 WIB)'
        required: false
        default: 'wait'
        type: string
      subject_override:
        description: 'Email subject override (optional)'
        required: false
        type: string

permissions:
  contents: read

concurrency:
  group: insider-report
  cancel-in-progress: false

jobs:
  run:
    runs-on: ubuntu-latest
    env:
      PYTHONPATH: src
      SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
      SUPABASE_KEY: ${{ secrets.SUPABASE_KEY }}
      AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
      AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
      AWS_REGION: ${{ secrets.AWS_REGION }}
      SES_FROM_EMAIL: ${{ secrets.SES_FROM_EMAIL }}
      REPORT_RECIPIENTS: ${{ secrets.REPORT_RECIPIENTS }}
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Cache pip
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements*.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: Install deps
        run: |
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi

      - name: Prepare dirs & filenames (Jakarta date)
        id: prep
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p data/tmp data/report data/company logs
          DAY=$(TZ=Asia/Jakarta date +%Y%m%d)
          echo "DAY=$DAY" >> "$GITHUB_OUTPUT"
          echo "FILINGS_JSON=data/tmp/filings_${DAY}.json"      >> "$GITHUB_OUTPUT"
          echo "OUT_JSON=data/report/insider_report_${DAY}.json" >> "$GITHUB_OUTPUT"
          echo "OUT_HTML=data/report/insider_email_${DAY}.html"  >> "$GITHUB_OUTPUT"

      - name: Resolve send, timing & recipients
        id: sendcfg
        shell: bash
        run: |
          set -euo pipefail
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            SEND="${{ inputs.send }}"
            case "${{ inputs.send_timing }}" in
              now|NOW|Now) DO_WAIT="false" ;;
              *) DO_WAIT="true" ;;
            esac
          else
            SEND="true"
            DO_WAIT="true"  # scheduled runs always wait
          fi
          RECIPS="${{ inputs.recipients_override }}"
          if [ -z "$RECIPS" ]; then RECIPS="$REPORT_RECIPIENTS"; fi
          echo "send=$SEND"        >> "$GITHUB_OUTPUT"
          echo "do_wait=$DO_WAIT"  >> "$GITHUB_OUTPUT"
          echo "recips=$RECIPS"    >> "$GITHUB_OUTPUT"

      - name: Configure WhatsApp send
        id: sendwacfg
        shell: bash
        run: |
          # Default to 'true' for scheduled runs
          SEND_WA='true' 
          # For manual runs, override the default with the user's choice
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            SEND_WA="${{ inputs.send_whatsapp }}"
          fi
          echo "send_wa=${SEND_WA}" >> $GITHUB_OUTPUT

      # Refresh company map & latest prices (enrichment dependency)
      - name: Build company_map & latest_prices (refresh_all)
        shell: bash
        run: |
          set -euo pipefail
          python src/scripts/company_map_hybrid.py refresh_all
          test -s data/company/company_map.json || { echo "company_map.json missing"; exit 1; }

      # ===== Phase A: Build (export + fetch + render) WITHOUT sending =====
      - name: Build command (dry-run)
        id: build
        shell: bash
        run: |
          set -euo pipefail
          FILINGS_JSON="${{ steps.prep.outputs.FILINGS_JSON }}"
          OUT_JSON="${{ steps.prep.outputs.OUT_JSON }}"
          OUT_HTML="${{ steps.prep.outputs.OUT_HTML }}"

          CMD=( python -m src.generate.reports.cli
            --export-company-report
            --company-script src/scripts/company_report.py
            --company-select "symbol,company_name,listing_board,tags"
            # --listing-board watchlist   # enable if yakin tidak mengosongkan
            --fetch-filings
            --fetch-script src/scripts/fetch_filings.py
            --fetch-out "$FILINGS_JSON"
            --company-map-json data/company/company_map.json
            --template src/generate/reports/templates/insider_email.html
            --out-json "$OUT_JSON"
            --out-html "$OUT_HTML"
            --dry-run
          )
          if [ -n "${{ inputs.from }}" ] && [ -n "${{ inputs.to }}" ]; then
            CMD+=( --from "${{ inputs.from }}" --to "${{ inputs.to }}" )
          fi
          if [ -n "${{ inputs.symbols }}" ]; then
            CMD+=( --symbols "${{ inputs.symbols }}" )
          fi
          if [ -n "${{ inputs.subject_override }}" ]; then
            CMD+=( --subject "${{ inputs.subject_override }}" )
          fi
          printf '%s\0' "${CMD[@]}" > cmd_build.zsharray

      - name: Run build (dry-run)
        shell: bash
        run: |
          set -euo pipefail
          mapfile -d '' CMD < cmd_build.zsharray
          echo "[BUILD]" "${CMD[@]}"
          "${CMD[@]}"

      # ===== Phase B: Wait until 18:00 WIB (only if sending AND do_wait) =====
      - name: Wait until 18:00 WIB (11:00 UTC)
        if: steps.sendcfg.outputs.send == 'true' && steps.sendcfg.outputs.do_wait == 'true'
        shell: bash
        run: |
          set -euo pipefail
          NOW=$(date -u +%s)
          TODAY=$(date -u +%Y-%m-%d)
          TARGET=$(date -u -d "$TODAY 11:00" +%s)
          WAIT=$(( TARGET - NOW ))
          if [ $WAIT -gt 0 ]; then
            echo "Sleeping $WAIT seconds until 11:00 UTC (18:00 WIB)..."
            sleep $WAIT
          else
            echo "It's past 11:00 UTC already; skipping wait."
          fi

      # ===== Phase C: Send-only (reuse JSON from Phase A) =====
      - name: Resolve generated JSON paths for send
        if: steps.sendcfg.outputs.send == 'true'
        id: resolvejson
        shell: bash
        run: |
          set -euo pipefail
          echo "FILINGS_JSON=${{ steps.prep.outputs.FILINGS_JSON }}" >> "$GITHUB_OUTPUT"
          COMP_JSON=$(ls -t data/tmp/company_report_*.json 2>/dev/null | head -n1 || true)
          if [ -z "$COMP_JSON" ]; then
            echo "Tidak menemukan company_report_*.json — apakah --export-company-report berhasil?" >&2
            exit 1
          fi
          echo "COMP_JSON=$COMP_JSON" >> "$GITHUB_OUTPUT"

      - name: Send command
        if: steps.sendcfg.outputs.send == 'true'
        id: sendcmd
        shell: bash
        run: |
          set -euo pipefail
          RECIPS="${{ steps.sendcfg.outputs.recips }}"
          COMP_JSON="${{ steps.resolvejson.outputs.COMP_JSON }}"
          FILINGS_JSON="${{ steps.resolvejson.outputs.FILINGS_JSON }}"
          OUT_JSON="${{ steps.prep.outputs.OUT_JSON }}"
          OUT_HTML="${{ steps.prep.outputs.OUT_HTML }}"

          CMD=( python -m src.generate.reports.cli
            --filings-json-in "$FILINGS_JSON"
            --companies-json-in "$COMP_JSON"
            --company-map-json data/company/company_map.json
            --template src/generate/reports/templates/insider_email.html
            --out-json "$OUT_JSON"
            --out-html "$OUT_HTML"
            --send --mail-to "$RECIPS"
          )
          # >>> penting: jaga window tetap sama seperti Build <<<
          if [ -n "${{ inputs.from }}" ] && [ -n "${{ inputs.to }}" ]; then
            CMD+=( --from "${{ inputs.from }}" --to "${{ inputs.to }}" )
          fi
          # subject override juga dipass ke fase send
          if [ -n "${{ inputs.subject_override }}" ]; then
            CMD+=( --subject "${{ inputs.subject_override }}" )
          fi
          if [ "${{ inputs.attach_html }}" = 'true' ]; then
            CMD+=( --attach-html )
          fi
          printf '%s\0' "${CMD[@]}" > cmd_send.zsharray

      - name: Run send
        if: steps.sendcfg.outputs.send == 'true'
        shell: bash
        run: |
          set -euo pipefail
          mapfile -d '' CMD < cmd_send.zsharray
          echo "[SEND]" "${CMD[@]}"
          "${CMD[@]}"
        
      - name: Run send (WhatsApp)
        if: steps.sendwacfg.outputs.send_wa == 'true'
        shell: bash 
        env: 
          PYTHONPATH: src
          REPORT_JSON_PATH: ${{ steps.prep.outputs.OUT_JSON }}
          WHATSAPP_RECIPIENTS: ${{ inputs.whatsapp_recipients_override || secrets.WHATSAPP_RECIPIENTS }}
          TWILIO_ACCOUNT_SID: ${{ secrets.TWILIO_ACCOUNT_SID }}
          TWILIO_AUTH_TOKEN: ${{ secrets.TWILIO_AUTH_TOKEN }}
          TWILIO_FROM_NUMBER: ${{ secrets.TWILIO_FROM_NUMBER }}
          TEMPLATE_SID: ${{ secrets.TEMPLATE_SID }}

        run: | 
          set -euo pipefail
          if [ -z "$WHATSAPP_RECIPIENTS" ]; then
            echo "Skipping WhatsApp: Recipient not set."
            exit 0
          fi
          
          echo "Running WhatsApp Sender CLI..."
          python -m src.generate.reports.whatsapp_cli \
            --json-in "$REPORT_JSON_PATH" \
            --to "$WHATSAPP_RECIPIENTS"

      - name: Upload artifacts (HTML & JSON)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: insider-report
          path: |
            data/report/insider_email_*.html
            data/report/insider_report_*.json
          if-no-files-found: ignore
