name: IDX Filings â€” Manual

on:
  workflow_dispatch:
    inputs:
      mode:
        description: "Run mode"
        type: choice
        required: true
        default: lookback
        options: [single_day, range, lookback]
      date:
        description: "YYYYMMDD (single_day)"
        required: false
      start_hhmm:
        description: "HH:MM WIB (single_day)"
        required: false
      end_hhmm:
        description: "HH:MM WIB (single_day)"
        required: false
      from_date:
        description: "YYYYMMDD (range)"
        required: false
      to_date:
        description: "YYYYMMDD (range)"
        required: false
      window_minutes:
        description: "Lookback minutes (lookback)"
        required: false
        default: "120"
      upload_to_supabase:
        description: "Upload filings to Supabase? (needs secrets)"
        type: boolean
        default: false
      table:
        description: "Supabase table (if uploading)"
        required: false
        default: "idx_filings"
      verbose:
        description: "Verbose logs?"
        type: boolean
        default: true

env:
  PYTHONPATH: src
  TZ: Asia/Jakarta

concurrency:
  group: idx-filings-manual
  cancel-in-progress: true

jobs:
  run:
    runs-on: ubuntu-latest
    timeout-minutes: 60
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"
          cache: "pip"

      - name: Install dependencies
        run: |
          python -m pip install -U pip
          pip install -r requirements.txt

      # Pre-clean SELALU ON agar idempotent
      - name: Pre-clean
        run: |
          rm -rf downloads/idx-format downloads/non-idx-format || true
          rm -rf data/*.json alerts/*.json alerts_inserted alerts_not_inserted artifacts/*.zip || true
          mkdir -p downloads/idx-format downloads/non-idx-format data alerts artifacts

      # Build & RUN in one step (pakai bash array biar quotings aman)
      - name: Run orchestrator
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_KEY: ${{ secrets.SUPABASE_KEY }}
          # ===== PROXY from single secret =====
          HTTP_PROXY:  ${{ secrets.PROXY }}
          HTTPS_PROXY: ${{ secrets.PROXY }}
          http_proxy:  ${{ secrets.PROXY }}
          https_proxy: ${{ secrets.PROXY }}
          NO_PROXY: "localhost,127.0.0.1"
        shell: bash
        run: |
          set -euo pipefail

          ARGS=( "--zip-artifacts" "--artifact-prefix" "filings" )
          if [[ "${{ inputs.verbose }}" == "true" ]]; then ARGS+=("-v"); fi

          case "${{ inputs.mode }}" in
            single_day)
              if [[ -z "${{ inputs.date }}" || -z "${{ inputs.start_hhmm }}" || -z "${{ inputs.end_hhmm }}" ]]; then
                echo "::error::single_day mode requires date, start_hhmm, end_hhmm"; exit 1
              fi
              ARGS+=( "--date" "${{ inputs.date }}" "--start-hhmm" "${{ inputs.start_hhmm }}" "--end-hhmm" "${{ inputs.end_hhmm }}" )
              ;;
            range)
              if [[ -z "${{ inputs.from_date }}" || -z "${{ inputs.to_date }}" ]]; then
                echo "::error::range mode requires from_date and to_date"; exit 1
              fi
              ARGS+=( "--from-date" "${{ inputs.from_date }}" "--to-date" "${{ inputs.to_date }}" )
              ;;
            lookback)
              WIN="${{ inputs.window_minutes }}"; [[ -z "$WIN" ]] && WIN="120"
              ARGS+=( "--window-minutes" "$WIN" )
              ;;
          esac

          if [[ "${{ inputs.upload_to_supabase }}" == "true" ]]; then
            if [[ -n "${SUPABASE_URL:-}" && -n "${SUPABASE_KEY:-}" ]]; then
              ARGS+=( "--upload" "--table" "${{ inputs.table }}" )
            else
              echo "::warning::upload_to_supabase=true, but SUPABASE_URL/KEY secrets missing. Skipping upload."
            fi
          fi

          echo "python -m pipeline.orchestrator ${ARGS[*]}"
          python -m pipeline.orchestrator "${ARGS[@]}"

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: filings-manual-${{ github.run_number }}
          path: |
            artifacts/*.zip
            data/*.json
            alerts/*.json
            alerts_inserted/*.json
            alerts_not_inserted/*.json
          if-no-files-found: warn
          retention-days: 14
          compression-level: 6
