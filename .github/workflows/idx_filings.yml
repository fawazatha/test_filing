name: IDX Filings

on:
  schedule:
    - cron: "0 */2 * * *"  
  workflow_dispatch:
    inputs:
      mode:
        description: "Run mode"
        type: choice
        required: true
        default: lookback
        options: [single_day, range, lookback]
      date:
        description: "YYYYMMDD (single_day)"
        required: false
      start_hhmm:
        description: "HH:MM WIB (single_day)"
        required: false
      end_hhmm:
        description: "HH:MM WIB (single_day)"
        required: false
      from_date:
        description: "YYYYMMDD (range)"
        required: false
      to_date:
        description: "YYYYMMDD (range)"
        required: false
      window_minutes:
        description: "Lookback minutes (lookback)"
        required: false
        default: "120"
      upload_to_supabase:
        description: "Upload filings to Supabase? (needs secrets)"
        type: boolean
        default: false
      table:
        description: "Supabase table (if uploading)"
        required: false
        default: "idx_filings"
      verbose:
        description: "Verbose logs?"
        type: boolean
        default: true

env:
  PYTHONPATH: src
  TZ: Asia/Jakarta
  OVERLAP_MINUTES: "1"   # buffer 1 menit untuk run terjadwal

concurrency:
  group: idx-filings-manual
  cancel-in-progress: true

jobs:
  run:
    runs-on: ubuntu-latest
    timeout-minutes: 60
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"
          cache: "pip"

      - name: Install dependencies
        run: |
          python -m pip install -U pip
          pip install -r requirements.txt

      # Pre-clean SELALU ON agar idempotent
      - name: Pre-clean
        run: |
          rm -rf downloads/idx-format downloads/non-idx-format || true
          rm -rf data/*.json alerts/*.json alerts_inserted alerts_not_inserted artifacts/*.zip || true
          mkdir -p downloads/idx-format downloads/non-idx-format data alerts artifacts

      # Timestamp WIB untuk nama artifact
      - name: Compute run timestamp (WIB)
        id: ts
        run: echo "stamp=$(date +'%Y%m%d-%H%M%S')" >> "$GITHUB_OUTPUT"

      - name: Run orchestrator
        env:
          # Supabase (pakai service_role untuk bypass RLS)
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE }}
          # Penting: JANGAN lewat proxy untuk IDX & Supabase
          HTTP_PROXY: ""
          HTTPS_PROXY: ""
          NO_PROXY: "localhost,127.0.0.1,idx.co.id,.idx.co.id,supabase.co,.supabase.co"
        shell: bash
        run: |
          set -euo pipefail

          ARGS=( "--zip-artifacts" "--artifact-prefix" "filings" )

          # Verbose saat schedule atau jika input verbose=true
          if [[ "${{ inputs.verbose }}" == "true" || "${{ github.event_name }}" == "schedule" ]]; then
            ARGS+=("-v")
          fi

          if [[ "${{ github.event_name }}" == "schedule" ]]; then
            # TERJADWAL: lookback 120 + buffer 1 menit, dan force upload
            WIN=$(( 120 + ${OVERLAP_MINUTES:-1} ))
            ARGS+=( "--window-minutes" "$WIN" "--upload" "--table" "idx_filings" )
          else
            # MANUAL: hormati input pengguna
            MODE="${{ inputs.mode }}"
            case "$MODE" in
              single_day)
                if [[ -z "${{ inputs.date }}" || -z "${{ inputs.start_hhmm }}" || -z "${{ inputs.end_hhmm }}" ]]; then
                  echo "::error::single_day mode requires date, start_hhmm, end_hhmm"; exit 1
                fi
                ARGS+=( "--date" "${{ inputs.date }}" "--start-hhmm" "${{ inputs.start_hhmm }}" "--end-hhmm" "${{ inputs.end_hhmm }}" )
                ;;
              range)
                if [[ -z "${{ inputs.from_date }}" || -z "${{ inputs.to_date }}" ]]; then
                  echo "::error::range mode requires from_date and to_date"; exit 1
                fi
                ARGS+=( "--from-date" "${{ inputs.from_date }}" "--to-date" "${{ inputs.to_date }}" )
                ;;
              lookback|*)
                WIN="${{ inputs.window_minutes || '120' }}"
                ARGS+=( "--window-minutes" "$WIN" )
                ;;
            esac

            # Upload hanya jika diminta saat manual
            if [[ "${{ inputs.upload_to_supabase }}" == "true" ]]; then
              ARGS+=( "--upload" "--table" "${{ inputs.table }}" )
            fi
          fi

          echo "python -m pipeline.orchestrator ${ARGS[*]}"
          python -m pipeline.orchestrator "${ARGS[@]}"

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: filings-manual-${{ steps.ts.outputs.stamp }}-run${{ github.run_number }}
          path: |
            artifacts/*.zip
            data/*.json
            alerts/*.json
            alerts_inserted/*.json
            alerts_not_inserted/*.json
          if-no-files-found: warn
          retention-days: 14
          compression-level: 6
